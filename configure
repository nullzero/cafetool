#!/bin/bash

gemsql(){
	[[  "$(gem query --local)" =~ "mysql" ]] && return
	yes | zenity --progress --width 350 --pulsate --text=\
"Downloading mysql
" --title="cafeprompt" --no-cancel &
	gksu gem install mysql
	killall zenity
}

setting(){
	mkdir $current_dir/config
	mkdir $current_dir/workspace
	mv /tmp/cafe_path $current_dir/config/path
}

select_workspace(){
	zenity --info --title="cafetool" --text="\
Please choosing workspace directory.
Workspace directory will contain your source codes.
Make sure that you choose an accessible directory.
"
	workspace=$(zenity --file-selection --title="Choosing workspace" \
--directory --filename="$current_dir/workspace/")
	( ! (echo "test accessing" >> $workspace/test) 2> /dev/null ) && return 1
	rm $workspace/test
	echo "workspace: $workspace" >> $current_dir/config/path
}

geditconf(){
	ln -s $current_dir/gedit/cafetool_gedit \
~/.gnome2/gedit/tools/cafetool_gedit
	ln -s $current_dir/gedit/terminal_gedit \
~/.gnome2/gedit/tools/terminal_gedit
	[ "$(pidof gedit)" == "" ] && return
	if zenity --question --title="cafetool" --text="\
You need to restart gedit.
Do you want to restart gedit now ?" \
--ok-label="Yes" --cancel-label="No"; then
		killall gedit
		gedit &
	fi
}

geanyconf(){
	$current_dir/geany/geanyconf
	[ "$(pidof geany)" == "" ] && return
	if zenity --question --title="cafetool" --text="\
You need to restart geany.
Do you want to restart geany now ?" \
--ok-label="Yes" --cancel-label="No"; then
		killall geany
		geany &
	fi
}

current_dir=$(dirname $0)
gemsql
setting
while ! select_workspace; do :; done
[ $(type gedit) != "" ] && geditconf
[ $(type geany) != "" ] && geanyconf
