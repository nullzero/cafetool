#!/bin/bash

gemsql(){
	[[  "$(gem query --local)" =~ "mysql" ]] && return
	yes | zenity --progress --width 350 --pulsate --text=\
"Downloading mysql
" --title="cafeprompt" --no-cancel &
	gksu gem install mysql
	killall zenity
}

setting(){
	mkdir $current_dir/config
	mkdir $current_dir/workspace
	mv /tmp/cafe_path $current_dir/config/path
}

select_workspace(){
	zenity --info --title="cafetool" --text="\
Please choosing workspace directory.
Workspace directory will contain your source codes.
Make sure that you choose an accessible directory.
"
	workspace=$(zenity --file-selection --title="Choosing workspace" \
--directory --filename="$current_dir/workspace/")
	( ! (echo "test accessing" >> $workspace/test) 2> /dev/null ) && return 1
	rm $workspace/test
	echo "workspace: $workspace" >> $current_dir/config/path
}

geditconf(){
	ln -s $current_dir/gedit/cafetool_gedit \
~/.gnome2/gedit/tools/cafetool_gedit
	ln -s $current_dir/gedit/terminal_gedit \
~/.gnome2/gedit/tools/terminal_gedit
	[ "$(pidof gedit)" == "" ] && return
	zenity --question --title="cafetool" --text="\
You need to restart gedit.
Save your file(s) and click OK button for restart" \
--ok-label="Yes" --cancel-label="No"
	killall gedit
	gedit &
}

geanyconf(){
	if [ "$(pidof geany)" != "" ]; then
		zenity --info --title="cafetool" --text="\
You need to restart geany.
Save your file(s) and click OK button for restart"
		killall geany
		$current_dir/geany/geanyconf
		geany &
	else
		geany &
		while [ "$(pidof geany)" == "" ]; do :; done
		killall geany
		$current_dir/geany/geanyconf
	fi
}

current_dir=$(dirname $0)
gemsql
setting
while ! select_workspace; do :; done
[ $(type gedit) != "" ] && geditconf
[ $(type geany) != "" ] && geanyconf
